//     Backbone.BaseView 0.8.3
//     (c) 2014 James Ballantine, 1stdibs.com Inc.
//     Backbone.BaseView may be freely distributed under the MIT license.
//     For all details and documentation:
//     https://github.com/1stdibs/backbone-base-and-form-view
!function(a){"use strict";function b(a,b){var c=b.split(" "),d=c.length>1?this[c[1]]:this;a=s(a)?a:this[a],d&&(this.stopListening(d,c[0],a),this.listenTo(d,c[0],a))}function c(a,b,c,d){var e,g,h=d>1?a.getViewPath():null,i=1===d%2;for(c.unshift(b),c.push(a),g=a;g;){if(h&&f(g,c,h),i&&w.apply(g,c),e=g._stopPropogation,e&&e[b])return e[b]=!1,this;g=g.parentView}}function d(a,b,c){c.unshift(b),c.push(a),e([a],b,c)}function e(a,b,c){for(var d,f,g,h=-1,i=a.length;++h<i;)g=!0,w.apply(a[h],c),f=a[h]._stopPropogation,f&&f[b]&&(f[b]=!1,g=!1),d=a[h].subViews,g&&d&&d.length&&e(d,b,c)}function f(a,b,c){var d=l.rest(c,a.getViewPath().length);b=b.slice(0),b[0]=b[0]+(d.length?":"+d.join("."):""),w.apply(a,b)}function g(){this.trigger(x);var a=this._renderFn();return this.trigger(y),a}function h(){this.trigger(B,p.call(arguments))}function i(){var a=this,b=s(a.getReadyPromise)?a.getReadyPromise():null;return b&&s(b.then)?(a.trigger(z),b.then(l.bind(g,a),l.bind(h,a)),a):g.call(a)}function j(b){for(var c=b.split("."),d=a[c.shift()];c.length&&d;)d=d[c.shift()];return d}var k=a.Backbone,l=a._;"undefined"!=typeof module&&(l=require("underscore"),a=a||{},a.Backbone=k=require("backbone"),module.exports=k);var m,n,o=[],p=Array.prototype.slice,q=l.result,r=l.each,s=l.isFunction,t=l.isObject,u=l.isArray,v=k.View,w=k.Events.trigger,x="viewWillRender",y="viewDidRender",z="viewWaitingToRender",A="viewAppendedToParent",B="viewRenderFailure",C=2,D=3,E=function(a,b,c){this.config={},this.clear(!0),this.parent=b,this.options=c||{},this.autoInitSingletons=!!this.options.autoInitSingletons,this.defaultToSingletons=this.options.defaultToSingletons,this.dotNotation=void 0!==this.options.dotNotation?this.options.dotNotation:!0,a&&this.addConfig(a)};E.prototype={add:function(a,b,c){var d,e,f,g=u(a)?a:u(b)?b:void 0,h=!g&&t(a)&&a instanceof v==!1?a:void 0,i=g||b instanceof v!=!1?void 0:b;if(h){c="boolean"==typeof b?b:void 0;for(d in h)if(h.hasOwnProperty(d))if(h[d]=u(h[d])?h[d]:[h[d]],f=h[d].length,f&&h[d][0]instanceof v)this._addInstance(d,h[d],c);else for(e=-1;++e<f;)this._init(d,h[d][e],c);return this}if(b=a instanceof v?a:b,a="string"==typeof a||"number"==typeof a?a:void 0,c="boolean"==typeof c?c:a||"boolean"!=typeof b?void 0:b,i)return this._init(a,i,c),this;if(g&&(f=g.length)){if(g[0]instanceof v)this._addInstance(a,g,c);else for(e=-1;++e<f;)this._init(a,g[e],c);return this}return b?this._addInstance(a,b,c):a&&this._init(a,c),this},addInstance:function(a,b){return a instanceof v&&(b=a,a=void 0),this._addInstance(a,b),this},addInstances:function(a,b){u(a)&&(b=a,a=void 0);for(var c=-1,d=b.length;++c<d;)this._addInstance(a,b[c]);return this},addInstancesWithMap:function(a){var b;for(b in a)a.hasOwnProperty(b)&&this.addInstance(b,a[b]);return this},create:function(a,b){return this._init(a,b)},createFromKeys:function(a,b){for(var c=[],d=a.length,e=-1;++e<d;)c.push(this._init(a[e],b));return c},createSingletons:function(a){var b;for(b in this.config)this.config.hasOwnProperty(b)&&this.config[b].singleton&&this._init(b,a);return this},createWithMap:function(a){var b;for(b in a)a.hasOwnProperty(b)&&this._init(b,a[b]);return this},setSingleton:function(a,b){return this._addInstance(a,b,!0),this},overrideSingleton:function(a,b){return this.remove(a),this.setSingleton(a,b)},addConfig:function(a,b){var c=t(a)&&!u(a)?a:!1;return c?(r(c,this._addConfig,this),this):this._addConfig(b,a)},render:function(a){a=a||{};var b=a.appendTo||a.useLocation;return this._render(this.subViews,b,a.clearLocations)},renderAppend:function(a,b){return b=b||{},t(a)&&a instanceof k.$==!1&&!l.isElement(a)&&(b=a,a=b.appendTo),this._render(this.subViews,a||!0,b.clearLocations)},renderByKey:function(a,b){var c=this.getByType(a)||this.get(a);return u(c)||(c=[c]),b=b||{},this._render(c,b.appendTo||b.useLocation,b.clearLocations)},filteredSubs:function(a){var b,c,d=-1,e=new E(null,this.parent,this.options);for(e.config=this.config,c=u(a)?a:s(a)?this.filter(a):this.getByType(a),b=c.length;++d<b;)e.add(c[d]._subviewtype,c[d]);return e},descend:function(a,b){var c=s(a),d=function(e){for(var f,g,h=-1,i=e.length;++h<i;)f=e[h],g=c?a:f[a],g&&(b?g.apply(f,b):g.call(e[h])),f.subViews&&f.subViews.length&&d(f.subViews)};return d(this.subViews),this},clear:function(a,b){return a||this.removeElems(),this.subViews=[],this.parent&&this.parent.subViews&&(this.parent.subViews=this.subViews),this._subViewsByType={},this._subViewSingletons={},this._subViewsByCid={},this._subViewsByModelCid={},b&&(this.config={}),this},remove:function(a,b){var c,d=a&&("string"==typeof a||a.cid)?this.get(a):a;if(!d)return this;for(u(d)||(d=[d]),c=d?d.length:0,b||this.removeElems(d),c&&this.trigger("remove",d);d&&d.length;)this._remove(d.shift());return this},removeByKeys:function(a,b){var c=0,d=a?a.length:0;for(c;d>c;c++)this.remove(a[c],b);return this},removeElems:function(a){a=a||this.subViews;for(var b=-1,c=a.length;++b<c;)a[b].remove();return this},detachElems:function(a){a=a||this.subViews;for(var b=-1,c=a.length;++b<c;)a[b].$el.detach();return this},get:function(a){if(a.cid)return this._subViewsByCid[a.cid]||this._subViewsByModelCid[a.cid];if(a.indexOf(".")>-1&&this.dotNotation){for(var b=a.split("."),c=this.parent;b.length&&c;)c=c.subs.get(b.shift());return c}return this._subViewSingletons[a]||this._subViewsByCid[a]||this._subViewsByModelCid[a]||this._subViewsByType[a]},getByType:function(a){return this._subViewsByType[a]?this._subViewsByType[a]:this._subViewSingletons[a]?[this._subViewSingletons[a]]:[]},getSubViewType:function(a){return a=a instanceof v==!0?a:this.get(a),a._subviewtype},at:function(a){return this.subViews[a]},clearLocations:function(a){var b=a?l.pick(this.config,a):this.config;return r(b,function(a){this.parent.$(a.location).html("")},this),this},setLocationForType:function(a,b){return this._addConfig({location:b},a),this},useDefaultLocationSelectors:function(a){var b;a=l.isString(a)?a:"-container";for(b in this.config)this.config.hasOwnProperty(b)&&!this.config[b].location&&this.setLocationForType(b,"."+b+a);return this},_render:function(a,b,c){var d,e,f,g=-1,h={};for(b!==!0&&(d=b),c&&this.clearLocations();++g<a.length;)if(f=a[g],f.render(),d)f.$el.appendTo("string"==typeof d?this.parent.$(d).first():d);else if(b&&(e=this.config[this.getSubViewType(f)].location)){if("string"==typeof e)h[e]||(h[e]=this.parent.$(e).first()),e=h[e];else if("function"==typeof e&&(e=e.call(f),!(e instanceof k.$)))throw new Error("location function must return instance of jQuery");e.append(f.$el),f.trigger("appendToParent")}return this},_addInstance:function(a,b,c){var d,e=-1,f=this;if(a=a||"_svid_"+l.size(this.config),f._subViewSingletons[a])return f;for(u(b)||(b=[b]),d=b.length,f.config[a]||(f.config[a]={singleton:c}),!f.config[a].construct&&b[0].constructor&&(f.config[a].construct=b[0].constructor),c=void 0===c?f.config[a].singleton:c;++e<d;)f._setInst(a,b[e],c);return f},_addConfig:function(a,b){return a&&b?(this.config[b]=l.extend(this.config[b]||{},a),"boolean"!=typeof this.config[b].singleton&&(this.config[b].singleton=this.defaultToSingletons),this.autoInitSingletons&&this.config[b].singleton?this._init(b):this):this},_remove:function(a,b){for(var c=-1,d=this.subViews.length,e=this.getSubViewType(a),f=this.getByType(e);++c<d;)if(this.subViews[c].cid===a.cid){this.subViews.splice(c,1);break}if(d=f?f.length:0,!this._subViewSingletons[e]&&d)for(c=0;d>c;c++)if(f[c].cid===a.cid){f.splice(c,1);break}delete this._subViewsByCid[a.cid],a.model&&a.model.cid&&this._subViewsByModelCid[a.model.cid]&&delete this._subViewsByModelCid[a.model.cid],this._subViewSingletons[e]&&delete this._subViewSingletons[e],b||(a.trigger("removedAsSubView"),this.trigger("remove:"+e,a))},_setInst:function(a,b,c,d){var e=b.model?b.model.cid:null,f=this._subViewsByModelCid;return this.subViews.push(b),this._subViewsByCid[b.cid]=b,b.parentView||(b.parentView=this.parent),b._subviewtype=a,e&&(f[e]?(u(f[e])||(f[e]=[f[e]]),f[e].push(b)):this._subViewsByModelCid[e]=b),c="boolean"==typeof c?c:this.defaultToSingletons,c?this._subViewSingletons[a]=b:(this._subViewsByType[a]||(this._subViewsByType[a]=[]),this._subViewsByType[a].push(b)),this.newest=b,d?this:(b.trigger("addedAsSubView"),this.trigger("add",b).trigger("add:"+a,b))},_init:function(a,b,c){var d,e=this.config[a],f=e&&e.construct?e.construct:null;return this._subViewSingletons[a]?void 0:(b=l.extend({},e.options||{},b||{}),(f="string"==typeof f?j(f):f)?(d=new f(b,this.parent),this._setInst(a,d,void 0!==c?c:e.singleton),d):(console.error('Construct for key "'+a+'" was not found:',e?e.construct:""),void 0))}},r(["each","map","initial","rest","last","first","find","filter","sortBy","groupBy","where","findWhere","some","every","invoke","contains","max","min","size","without","indexOf","lastIndexOf","isEmpty","reject"],function(a){E.prototype[a]=function(){return l[a].apply(this,[this.subViews].concat(p.call(arguments)))}}),l.extend(E.prototype,k.Events),n=v.extend({_subviewtype:null,subViews:null,subs:null,subViewConfig:null,autoInitSubViews:!1,singletonSubViews:!1,parentView:null,wrapRenderFunction:!0,constructor:function(a,b){var c=a&&a.subViewConfig?a.subViewConfig:this.subViewConfig;c=s(c)?c.call(this):c,this.parentView=b instanceof v?b:null,this.subs=new E(null,this,{autoInitSingletons:this.autoInitSubViews,defaultToSingletons:this.singletonSubViews}),c&&this.subs.addConfig(c),this.subViews=this.subs.subViews,this._stopPropogation={},n.__super__.constructor.call(this,a),this.wrapRenderFunction&&(this._renderFn=this.render,this.render=i),this.viewEvents=a&&a.viewEvents?a.viewEvents:this.viewEvents,this.viewEvents&&this.bindViewEvents()},render:function(){var a="",b=this.template;return s(b)&&(a=b(q(this,"templateVars"))||""),this.subs.detachElems(),this.$el.html(a),this.subs.renderAppend(),this},place:function(a,b){var c=!!this.parentView;if("string"==typeof a){var d=c?this.parentView.$el:k.$("body");a=d.find(a)}return b?a.html(this.el):a.append(this.el),c&&this.trigger(A),this},remove:function(){return n.__super__.remove.call(this),this.subs.removeElems(),this},stopEvent:function(a){return console.assert(!!a,"event parameter is required"),this._stopPropogation[a]=!0,this},triggerBubble:function(a){return c(this,a,p.call(arguments,1),D),this},triggerBubbleNamespaced:function(a){return c(this,a,p.call(arguments,1),C),this},triggerDescend:function(a){return d(this,a,p.call(arguments,1)),this},ascend:function(a,b){for(var c,d=this,e=s(a);d.parentView;)d=d.parentView,d&&(c=e?a:d[a],c.apply(d,b));return this},findAncestor:function(a){for(var b=this;b.parentView;)if(b=b.parentView,b&&a(b))return b;return null},findAncestorByConstruct:function(a){return this.findAncestor(function(b){return b instanceof a})},findAncestorByType:function(a){return this.findAncestor(function(b){return a&&b._subviewtype===a})},getSubViewType:function(){return this._subviewtype},getTopView:function(){for(var a=this;a.parentView;)a=a.parentView;return a},isTopView:function(){return!this.parentView},getViewPath:function(){var a=[],b=function(){var b=this.getSubViewType();b&&a.unshift(b)};return b.call(this),this.ascend(b),a},trigger:function(a){if(m.isAutoBubbleEvent(a))return c(this,a,p.call(arguments,1),C);var b=arguments,d=b[1],e=b[2],f=b[3],g=b.length;switch(g){case 1:w.call(this,a);break;case 2:w.call(this,a,d);break;case 3:w.call(this,a,d,e);break;case 4:w.call(this,a,d,e,f);break;default:w.apply(this,b)}return this},bindViewEvents:function(a){return a=a||q(this,"viewEvents"),r(a,b,this),this}}),m=n.eventSettings={isAutoBubbleEvent:function(a){return l.indexOf(o,a)>-1},addAutoBubbleEvent:function(a){m.isAutoBubbleEvent(a)||o.push(a)},removeAutoBubbleEvent:function(a){var b=l.indexOf(o,a);o.splice(b,1)},addAutoBubbleEvents:function(a){r(a,m.addAutoBubbleEvent)}},k.BaseView=n}(this);