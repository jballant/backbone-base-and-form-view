//     Backbone.BaseView 0.9.0
//     (c) 2014 James Ballantine, 1stdibs.com Inc.
//     Backbone.BaseView may be freely distributed under the MIT license.
//     For all details and documentation:
//     https://github.com/1stdibs/backbone-base-and-form-view
!function(a){"use strict";function b(a,b,c,d){var e=b.split(" "),f=e.length>1?this[e[1]]:this;a=t(a)?a:this[a],f&&(this.stopListening(f,e[0],a),d||this.listenTo(f,e[0],a))}function c(a,c,d){b.call(this,a,c,d,!0)}function d(a,b,c,d){var e,f,h=a.getViewPath();for(c.unshift(b),c.push(a),f=a;f;){if(h&&g(f,c,h),d||x.apply(f,c),e=f._stopPropogation,e&&e[b])return e[b]=!1,this;f=f.parentView}}function e(a,b,c){c.unshift(b),c.push(a),f([a],b,c)}function f(a,b,c){for(var d,e,g,h=-1,i=a.length;++h<i;)g=!0,x.apply(a[h],c),e=a[h]._stopPropogation,e&&e[b]&&(e[b]=!1,g=!1),d=a[h].subViews,g&&d&&d.length&&f(d,b,c)}function g(a,b,c){var d=m.rest(c,a.getViewPath().length);b=b.slice(0),b[0]=b[0]+(d.length?":"+d.join("."):""),x.apply(a,b)}function h(){this._viewIsWaitingToRender=!1,this.trigger(y),this._viewIsRendering=!0;var a=this._renderFn();return this._viewIsRendering=!1,this._viewHasRendered=!0,this.trigger(z),a}function i(){this._viewIsWaitingToRender=!1,this.trigger(C,q.call(arguments))}function j(){var a=this,b=t(a.getReadyPromise)?a.getReadyPromise():null;return b&&t(b.then)?(a._viewIsWaitingToRender=!0,a.trigger(A),b.then(m.bind(h,a),m.bind(i,a)),a):h.call(a)}function k(b){for(var c=b.split("."),d=a[c.shift()];c.length&&d;)d=d[c.shift()];return d}var l=a.Backbone,m=a._;"undefined"!=typeof module&&(m=require("underscore"),a=a||{},a.Backbone=l=require("backbone"),module.exports=l);var n,o,p=[],q=Array.prototype.slice,r=m.result,s=m.each,t=m.isFunction,u=m.isObject,v=m.isArray,w=l.View,x=l.Events.trigger,y="viewWillRender",z="viewDidRender",A="viewWaitingToRender",B="viewAppendedToParent",C="viewRenderFailure",D="viewDidInitialize",E="viewAddedAsSubView",F=l.SubViewManager=function(a,b,c){this.config={},this.clear(!0),this.parent=b,this.options=c||{},this.autoInitSingletons=!!this.options.autoInitSingletons,this.defaultToSingletons=this.options.defaultToSingletons,this.dotNotation=void 0!==this.options.dotNotation?this.options.dotNotation:!0,this.treeOptions=c.treeOptions||{},a&&this.addConfig(a)};F.prototype={add:function(a,b,c){var d,e,f,g=v(a)?a:v(b)?b:void 0,h=!g&&u(a)&&a instanceof w==!1?a:void 0,i=g||b instanceof w!=!1?void 0:b;if(h){c="boolean"==typeof b?b:void 0;for(d in h)if(h.hasOwnProperty(d))if(h[d]=v(h[d])?h[d]:[h[d]],f=h[d].length,f&&h[d][0]instanceof w)this._addInstance(d,h[d],c);else for(e=-1;++e<f;)this._init(d,h[d][e],c);return this}if(b=a instanceof w?a:b,a="string"==typeof a||"number"==typeof a?a:void 0,c="boolean"==typeof c?c:a||"boolean"!=typeof b?void 0:b,i)return this._init(a,i,c),this;if(g&&(f=g.length)){if(g[0]instanceof w)this._addInstance(a,g,c);else for(e=-1;++e<f;)this._init(a,g[e],c);return this}return b?this._addInstance(a,b,c):a&&this._init(a,c),this},addInstance:function(a,b){return a instanceof w&&(b=a,a=void 0),this._addInstance(a,b),this},addInstances:function(a,b){v(a)&&(b=a,a=void 0);for(var c=-1,d=b.length;++c<d;)this._addInstance(a,b[c]);return this},addInstancesWithMap:function(a){var b;for(b in a)a.hasOwnProperty(b)&&this.addInstance(b,a[b]);return this},create:function(a,b){return this._init(a,b)},createFromKeys:function(a,b){for(var c=[],d=a.length,e=-1;++e<d;)c.push(this._init(a[e],b));return c},createSingletons:function(a){var b;for(b in this.config)this.config.hasOwnProperty(b)&&this.config[b].singleton&&this._init(b,a);return this},createWithMap:function(a){var b;for(b in a)a.hasOwnProperty(b)&&this._init(b,a[b]);return this},createWithConfig:function(a,b){return b=b||{},this.addConfig(a,b),this.autoInitSingletons&&b.singleton||this.create(a),this},setSingleton:function(a,b){return this._addInstance(a,b,!0),this},overrideSingleton:function(a,b){return this.remove(a),this.setSingleton(a,b)},addConfig:function(a,b){var c=u(a)&&!v(a)?a:!1;return c?(s(c,this._addConfig,this),this):this._addConfig(b,a)},render:function(a){a=a||{};var b=a.appendTo||a.useLocation;return this._render(this.subViews,b,a.clearLocations)},renderAppend:function(a,b){return b=b||{},u(a)&&a instanceof l.$==!1&&!m.isElement(a)&&(b=a,a=b.appendTo),this._render(this.subViews,a||!0,b.clearLocations)},renderByKey:function(a,b){var c=this.getByType(a)||this.get(a);return v(c)||(c=[c]),b=b||{},this._render(c,b.appendTo||b.useLocation,b.clearLocations)},filteredSubs:function(a){var b,c,d=-1,e=new F(null,this.parent,this.options);for(e.config=this.config,c=v(a)?a:t(a)?this.filter(a):this.getByType(a),b=c.length;++d<b;)e.add(c[d]._subviewtype,c[d]);return e},descend:function(a,b){var c=t(a),d=function(e){for(var f,g,h=-1,i=e.length;++h<i;)f=e[h],g=c?a:f[a],g&&(b?g.apply(f,b):g.call(e[h])),f.subViews&&f.subViews.length&&d(f.subViews)};return d(this.subViews),this},clear:function(a,b){return a||this.removeElems(),this.subViews=[],this.parent&&this.parent.subViews&&(this.parent.subViews=this.subViews),this._subViewsByType={},this._subViewSingletons={},this._subViewsByCid={},this._subViewsByModelCid={},b&&(this.config={}),this},remove:function(a,b){var c,d=a&&("string"==typeof a||a.cid)?this.get(a):a;if(!d)return this;for(v(d)||(d=[d]),c=d?d.length:0,b||this.removeElems(d),c&&this.trigger("remove",d);d&&d.length;)this._remove(d.shift());return this},removeByKeys:function(a,b){var c=0,d=a?a.length:0;for(c;d>c;c++)this.remove(a[c],b);return this},removeElems:function(a){a=a||this.subViews;for(var b=-1,c=a.length;++b<c;)a[b].remove();return this},detachElems:function(a){a=a||this.subViews;for(var b=-1,c=a.length;++b<c;)a[b].$el.detach();return this},get:function(a){if(a.cid)return this._subViewsByCid[a.cid]||this._subViewsByModelCid[a.cid];if(a.indexOf(".")>-1&&this.dotNotation){for(var b=a.split("."),c=this.parent;b.length&&c;)c=c.subs.get(b.shift());return c}return this._subViewSingletons[a]||this._subViewsByCid[a]||this._subViewsByModelCid[a]||this._subViewsByType[a]},getByType:function(a){return this._subViewsByType[a]?this._subViewsByType[a]:this._subViewSingletons[a]?[this._subViewSingletons[a]]:[]},getSubViewType:function(a){return a=a instanceof w==!0?a:this.get(a),a._subviewtype},getConfigForSubView:function(a){var b=this.getSubViewType(a);return this.config[b]},at:function(a){return this.subViews[a]},clearLocations:function(a){var b=a?m.pick(this.config,a):this.config;return s(b,function(a){this.parent.$(a.location).html("")},this),this},setLocationForType:function(a,b){return this._addConfig({location:b},a),this},useDefaultLocationSelectors:function(a){var b;a=m.isString(a)?a:"-container";for(b in this.config)this.config.hasOwnProperty(b)&&!this.config[b].location&&this.setLocationForType(b,"."+b+a);return this},assignTreeOptions:function(a){return this._clonedTreeOpts||(this.treeOptions=m.clone(this.treeOptions||{}),this._clonedTreeOpts=!0),m.extend(this.treeOptions,a),this},getOptionsForKey:function(a,b){var c=a&&this.config[a]?this.config[a]:{};return m.extend({},this.treeOptions||{},c.options||{},b||{})},_render:function(a,b,c){var d,e,f,g=-1,h={};for(b!==!0&&(d=b),c&&this.clearLocations();++g<a.length;)f=a[g],f.render(),d?this._appendSubViewTo(f,this._resolveLocation(d,f,h)):b&&(e=this.getConfigForSubView(f).location)&&this._appendSubViewTo(f,this._resolveLocation(e,f,h));return this},_resolveLocation:function(a,b,c){if("string"==typeof a)c[a]||(c[a]=this.parent.$(a).first()),a=c[a];else if("function"==typeof a&&(a=a.call(b),!(a instanceof l.$)))throw new Error("location function must return instance of jQuery");return a},_appendSubViewTo:function(a,b){a instanceof o?a.place(b):a.$el.appendTo(b)},_addInstance:function(a,b,c){var d,e=-1,f=this;if(a=a||"_svid_"+m.size(this.config),f._subViewSingletons[a])return f;for(v(b)||(b=[b]),d=b.length,f.config[a]||(f.config[a]={singleton:c}),!f.config[a].construct&&b[0].constructor&&(f.config[a].construct=b[0].constructor),c=void 0===c?f.config[a].singleton:c;++e<d;)f._setInst(a,b[e],c);return f},_addConfig:function(a,b){return a&&b?(this.config[b]=m.extend(this.config[b]||{},a),"boolean"!=typeof this.config[b].singleton&&(this.config[b].singleton=this.defaultToSingletons),this.autoInitSingletons&&this.config[b].singleton?this._init(b):this):this},_remove:function(a,b){for(var c=-1,d=this.subViews.length,e=this.getSubViewType(a),f=this.getByType(e);++c<d;)if(this.subViews[c].cid===a.cid){this.subViews.splice(c,1);break}if(d=f?f.length:0,!this._subViewSingletons[e]&&d)for(c=0;d>c;c++)if(f[c].cid===a.cid){f.splice(c,1);break}delete this._subViewsByCid[a.cid],a.model&&a.model.cid&&this._subViewsByModelCid[a.model.cid]&&delete this._subViewsByModelCid[a.model.cid],this._subViewSingletons[e]&&delete this._subViewSingletons[e],b||(a.trigger("removedAsSubView"),this.trigger("remove:"+e,a))},_setInst:function(a,b,c,d){var e=b.model?b.model.cid:null,f=this._subViewsByModelCid;return this.subViews.push(b),this._subViewsByCid[b.cid]=b,b.parentView||(b.parentView=this.parent),b._subviewtype=a,e&&(f[e]?(v(f[e])||(f[e]=[f[e]]),f[e].push(b)):this._subViewsByModelCid[e]=b),c="boolean"==typeof c?c:this.defaultToSingletons,c?this._subViewSingletons[a]=b:(this._subViewsByType[a]||(this._subViewsByType[a]=[]),this._subViewsByType[a].push(b)),this.newest=b,b instanceof o&&this.treeOptions&&b.assignTreeOptions(this.treeOptions),d?this:(b.trigger(E),this.trigger("add",b).trigger("add:"+a,b))},_init:function(a,b,c){var d,e=this.config[a],f=e&&e.construct?e.construct:null;return this._subViewSingletons[a]?void 0:(b=this.getOptionsForKey(a,b),(f="string"==typeof f?k(f):f)?(d=new f(b,this.parent),this._setInst(a,d,void 0!==c?c:e.singleton),d):(console.error('Construct for key "'+a+'" was not found:',e?e.construct:""),void 0))}},s(["each","map","initial","rest","last","first","find","filter","sortBy","groupBy","where","findWhere","some","every","invoke","contains","max","min","size","without","indexOf","lastIndexOf","isEmpty","reject"],function(a){F.prototype[a]=function(){return m[a].apply(this,[this.subViews].concat(q.call(arguments)))}}),m.extend(F.prototype,l.Events),F.extend=w.extend,o=l.BaseView=w.extend({_subviewtype:null,subViews:null,subs:null,subViewConfig:null,autoInitSubViews:!1,singletonSubViews:!1,parentView:null,wrapRenderFunction:!0,SubViewManager:F,constructor:function(a,b){var c=a&&a.subViewConfig?a.subViewConfig:this.subViewConfig;c=t(c)?c.call(this):c,this.parentView=b instanceof w?b:null,this.subs=new this.SubViewManager(null,this,{autoInitSingletons:this.autoInitSubViews,defaultToSingletons:this.singletonSubViews,treeOptions:b&&b.subs?b.subs.treeOptions:null}),c&&this.subs.addConfig(c),this.subViews=this.subs.subViews,this._stopPropogation={},o.__super__.constructor.call(this,a),this.wrapRenderFunction&&(this._renderFn=this.render,this.render=j),this.viewEvents=a&&a.viewEvents?a.viewEvents:this.viewEvents,this.viewEvents&&this.bindViewEvents(),this.trigger(D)},assignTreeOptions:function(a){return this.subs.assignTreeOptions(a),this},render:function(){var a="",b=this.template;return this.subs.detachElems(),t(b)&&(a=b(r(this,"templateVars"))||""),this._setElHtml(a),this._renderAppendSubViews(),this},place:function(a,b){var c=!!this.parentView;if("string"==typeof a){var d=c?this.parentView.$el:l.$("body");a=d.find(a)}else a=l.$(a);return b?a.html(this.el):a.append(this.el),c&&this.trigger(B),this},remove:function(){return o.__super__.remove.call(this),this.subs.removeElems(),this},stopEvent:function(a){return console.assert(!!a,"event parameter is required"),this._stopPropogation[a]=!0,this},triggerBubble:function(a){return d(this,a,q.call(arguments,1)),this},triggerBubbleNamespaced:function(a){return d(this,a,q.call(arguments,1),!0),this},triggerDescend:function(a){return e(this,a,q.call(arguments,1)),this},ascend:function(a,b){for(var c,d=this,e=t(a);d.parentView;)d=d.parentView,d&&(c=e?a:d[a],c.apply(d,b));return this},findAncestor:function(a){for(var b=this;b.parentView;)if(b=b.parentView,b&&a(b))return b;return null},findAncestorByConstruct:function(a){return this.findAncestor(function(b){return b instanceof a})},findAncestorByType:function(a){return this.findAncestor(function(b){return a&&b._subviewtype===a})},getSubViewType:function(){return this._subviewtype},getTopView:function(){for(var a=this;a.parentView;)a=a.parentView;return a},isTopView:function(){return!this.parentView},getViewPath:function(){var a=[],b=function(){var b=this.getSubViewType();b&&a.unshift(b)};return b.call(this),this.ascend(b),a},trigger:function(a){if(n.isAutoBubbleEvent(a))return d(this,a,q.call(arguments,1),!0);var b=arguments,c=b[1],e=b[2],f=b[3],g=b.length;switch(g){case 1:x.call(this,a);break;case 2:x.call(this,a,c);break;case 3:x.call(this,a,c,e);break;case 4:x.call(this,a,c,e,f);break;default:x.apply(this,b)}return this},bindViewEvents:function(a){return a=a||r(this,"viewEvents"),s(a,b,this),this},unbindViewEvents:function(a){return a=a||r(this,"viewEvents"),s(a,c,this),this},isWaitingToRender:function(){return!!this._viewIsWaitingToRender},isRendering:function(){return!!this._viewIsRendering},hasRendered:function(){return!!this._viewHasRendered},_setElHtml:function(a){this.$el.html(a)},_renderAppendSubViews:function(){this.subs.renderAppend()}}),n=o.eventSettings={isAutoBubbleEvent:function(a){return m.indexOf(p,a)>-1},addAutoBubbleEvent:function(a){n.isAutoBubbleEvent(a)||p.push(a)},removeAutoBubbleEvent:function(a){var b=m.indexOf(p,a);p.splice(b,1)},addAutoBubbleEvents:function(a){s(a,n.addAutoBubbleEvent)}}}(this);